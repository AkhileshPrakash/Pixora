<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixora - Telegram Photo Gallery</title>
    <!-- CRITICAL FIX: Telegram Login Widget Script -->
    <script async src="https://telegram.org/js/telegram-widget.js?22" 
            data-telegram-login="PixoraLoginBot" 
            data-size="large" 
            data-auth-url="https://pixora-backend-0lhr.onrender.com/api/auth/telegram" 
            data-request-access="write"></script>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark theme background */
            color: #e4e6eb;
        }
        .card {
            background-color: #2c2c54;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: #6a6a9b;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #53537e;
        }
        .input-style {
            background-color: #414168;
            border: 1px solid #6a6a9b;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Main Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold text-pink-400">Pixora</span>
            </div>
            <div id="auth-controls" class="space-x-4 flex items-center">
                <!-- User/Logout buttons will be inserted here -->
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Loading Indicator -->
            <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
                <div class="text-xl font-semibold flex flex-col items-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-pink-500 mb-4"></div>
                    Loading...
                </div>
            </div>

            <!-- Notification/Message Box -->
            <div id="message-box" class="hidden fixed top-20 right-4 p-4 card text-sm shadow-2xl z-50 transform transition-transform duration-300 translate-x-full"></div>
            
            <!-- Auth View -->
            <section id="auth-view" class="max-w-md mx-auto card p-6 mt-10">
                <h2 class="text-2xl font-semibold mb-6 text-center text-pink-400">Welcome to Pixora</h2>
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="email" placeholder="Email (Required)" required class="w-full p-3 input-style rounded-lg focus:ring-2 focus:ring-pink-400">
                    <input type="password" id="password" placeholder="Password (Required)" required class="w-full p-3 input-style rounded-lg focus:ring-2 focus:ring-pink-400">
                    <button type="submit" id="auth-button" class="w-full p-3 btn-primary rounded-lg font-semibold">Sign Up</button>
                </form>
                <button id="toggle-auth" class="w-full mt-4 text-sm text-center text-gray-400 hover:text-pink-400">
                    Already have an account? Log In
                </button>
                
                <div class="my-6 border-t border-gray-600/50 pt-6 text-center">
                    <p class="text-sm text-gray-400 mb-3">Or, link and log in instantly:</p>
                    <!-- Telegram Login Widget Placeholder -->
                    <div id="telegram-login-placeholder" class="flex justify-center">
                        <!-- Widget script loaded in <head> will render here -->
                    </div>
                </div>
            </section>

            <!-- Dashboard View -->
            <section id="dashboard-view" class="hidden">
                
                <!-- Linking & Upload Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Telegram Status Card -->
                    <div id="telegram-status-card" class="card p-6 flex flex-col justify-between lg:col-span-1">
                        <div class="flex items-center space-x-3 mb-4">
                            <span id="link-icon"></span>
                            <h3 class="text-xl font-semibold">Telegram Status</h3>
                        </div>
                        <p id="link-message" class="text-gray-400 mb-4">
                            Checking connection status...
                        </p>
                    </div>

                    <!-- Upload Panel -->
                    <div id="upload-panel" class="card p-6 lg:col-span-2 hidden">
                        <h3 class="text-xl font-semibold mb-4">Upload Files</h3>
                        <form id="upload-form" class="space-y-4">
                            <input type="file" id="file-input" multiple required class="w-full p-3 input-style rounded-lg focus:ring-2 focus:ring-pink-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-500 file:text-white hover:file:bg-pink-600">
                            <button type="submit" id="upload-btn" class="p-3 btn-primary rounded-lg font-semibold w-full flex items-center justify-center space-x-2">
                                <span data-lucide="upload-cloud" class="w-5 h-5"></span>
                                <span>Upload to Telegram Storage</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Gallery Section -->
                <h2 class="text-3xl font-bold mb-6 text-pink-400">Your Files</h2>
                <div id="gallery-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                
                <!-- Empty Gallery State -->
                <div id="empty-state" class="hidden text-center card p-12 mt-10">
                    <span data-lucide="folder-open" class="w-16 h-16 mx-auto text-gray-500 mb-4"></span>
                    <p class="text-xl text-gray-400">No files uploaded yet. Link your account with Telegram Login above!</p>
                </div>

            </section>
        </div>
    </main>

    <!-- The core application script -->
    <script type="module">
        // Import Supabase Client from CDN
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Wrap the entire module script in an IIFE for robustness against truncation errors
        (() => {
            // --- Supabase and Environment Setup ---
            const SUPABASE_URL = "https://wzxznrkmsgqabijkrrai.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6eHpucmttc2dxYWJpamtycmFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMzI3NTgsImV4cCI6MjA3NDYwODc1OH0.AIf1QQ2SNJE4xo2V0rBcMx9-kzXG1dD4sgNrxhUDdFI";
            
            // **CRITICAL FIX:** Use the live Render URL for backend communication
            const RENDER_URL = 'https://pixora-backend-0lhr.onrender.com';
            // Logic to determine BACKEND_URL for fetch calls (checks if running on localhost)
            const BACKEND_URL = window.location.origin.includes('localhost') 
                ? 'http://localhost:8082' 
                : RENDER_URL;

            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- DOM Elements ---
            const authView = document.getElementById('auth-view');
            const dashboardView = document.getElementById('dashboard-view');
            const authForm = document.getElementById('auth-form');
            const authButton = document.getElementById('auth-button');
            const toggleAuthBtn = document.getElementById('toggle-auth');
            const authControls = document.getElementById('auth-controls');
            const telegramStatusCard = document.getElementById('telegram-status-card');
            const linkIcon = document.getElementById('link-icon');
            const linkMessage = document.getElementById('link-message');
            const uploadPanel = document.getElementById('upload-panel');
            const uploadForm = document.getElementById('upload-form');
            const fileInput = document.getElementById('file-input');
            const galleryList = document.getElementById('gallery-list');
            const emptyState = document.getElementById('empty-state');
            const messageBox = document.getElementById('message-box');
            const loadingIndicator = document.getElementById('loading');
            
            let isSignUp = true;
            let telegramLinked = false;

            // --- Utility Functions ---

            /** Shows a temporary notification message */
            function showMessage(text, type = 'success') {
                messageBox.textContent = text;
                messageBox.className = 'fixed top-20 right-4 p-4 card text-sm shadow-2xl z-50 transform transition-transform duration-300';
                
                if (type === 'error') {
                    messageBox.classList.add('bg-red-700/70', 'text-red-100');
                } else if (type === 'info') {
                     messageBox.classList.add('bg-blue-700/70', 'text-blue-100');
                } else {
                    messageBox.classList.add('bg-green-700/70', 'text-green-100');
                }

                messageBox.classList.remove('translate-x-full');
                messageBox.classList.add('translate-x-0');

                setTimeout(() => {
                    messageBox.classList.remove('translate-x-0');
                    messageBox.classList.add('translate-x-full');
                }, 5000);
            }

            /** Shows/hides the loading overlay */
            function toggleLoading(show) {
                loadingIndicator.classList.toggle('hidden', !show);
            }

            /** Renders a single file card in the gallery */
            function renderFileCard(file) {
                const card = document.createElement('div');
                card.className = 'card p-4 flex flex-col space-y-2 hover:ring-2 hover:ring-pink-400 transition-all';
                card.innerHTML = `
                    <div class="text-pink-400 font-bold break-all">${file.original_filename}</div>
                    <div class="text-sm text-gray-400">${new Date(file.uploaded_at).toLocaleString()}</div>
                    <div class="text-xs text-gray-500">MIME: ${file.mime_type}</div>
                    <div class="text-xs text-gray-500 break-all">Telegram ID: ${file.telegram_file_id.substring(0, 15)}...</div>
                `;
                galleryList.appendChild(card);
            }

            // --- Core Application Logic ---

            /** Updates the view based on authentication status */
            function updateView(session) {
                const user = session?.user;
                const isLoggedIn = !!user;

                authView.classList.toggle('hidden', isLoggedIn);
                dashboardView.classList.toggle('hidden', !isLoggedIn);

                // Re-render the Telegram Widget if needed
                if (!isLoggedIn) {
                     // The widget script loaded in <head> will render the button automatically
                     // We just ensure the placeholder is empty here for cleanliness.
                     document.getElementById('telegram-login-placeholder').innerHTML = '';
                }

                if (isLoggedIn) {
                    // Render user info and logout button
                    authControls.innerHTML = `
                        <span class="text-sm text-gray-400 hidden sm:inline">Logged in as: ${user.email}</span>
                        <button id="logout-btn" class="p-2 bg-red-600 rounded-lg text-sm text-white hover:bg-red-700 font-semibold flex items-center space-x-1">
                            <span data-lucide="log-out" class="w-4 h-4"></span>
                            <span>Logout</span>
                        </button>
                    `;
                    lucide.createIcons(); 
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                    
                    checkTelegramLinkStatus();
                    fetchGallery(); // Fetch gallery data
                } else {
                    authControls.innerHTML = '';
                }
            }

            /** Checks if the user has a linked Telegram chat ID */
            async function checkTelegramLinkStatus() {
                toggleLoading(true);
                try {
                    const session = supabase.auth.session();
                    if (!session) return;
                    
                    // Use the backend status endpoint
                    const response = await fetch(`${BACKEND_URL}/api/link/status`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${session.access_token}` }
                    });

                    const result = await response.json();

                    if (response.ok && result.linked) {
                        telegramLinked = true;
                        updateLinkStatusUI(true);
                    } else {
                        telegramLinked = false;
                        updateLinkStatusUI(false);
                    }
                } catch (err) {
                    console.error("Link status check failed:", err);
                    telegramLinked = false;
                    updateLinkStatusUI(false);
                } finally {
                    toggleLoading(false);
                }
            }

            /** Updates UI elements based on the link status */
            function updateLinkStatusUI(linked) {
                if (linked) {
                    telegramStatusCard.classList.remove('bg-red-700/30', 'border-red-500');
                    telegramStatusCard.classList.add('bg-green-700/30', 'border-green-500');
                    linkIcon.innerHTML = lucide.createIcons()['check-circle'].toSvg({ class: 'w-6 h-6 text-green-400' });
                    linkMessage.textContent = "✅ Account is securely linked via Telegram Login.";
                    // Hide the manual button elements
                    document.getElementById('link-telegram-btn').style.display = 'none';
                    uploadPanel.classList.remove('hidden');
                } else {
                    telegramStatusCard.classList.remove('bg-green-700/30', 'border-green-500');
                    telegramStatusCard.classList.add('bg-red-700/30', 'border-red-500');
                    linkIcon.innerHTML = lucide.createIcons()['x-octagon'].toSvg({ class: 'w-6 h-6 text-red-400' });
                    linkMessage.textContent = "❌ Not linked. Please click the 'Login with Telegram' button below.";
                    // Show the widget button
                    document.getElementById('link-telegram-btn').style.display = 'block';
                    uploadPanel.classList.add('hidden');
                }
            }

            // --- Authentication & Upload Handlers ---

            async function handleAuth(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                toggleLoading(true);

                try {
                    const { error } = isSignUp
                        ? await supabase.auth.signUp({ email, password })
                        : await supabase.auth.signInWithPassword({ email, password });

                    if (error) throw error;
                    const message = isSignUp 
                        ? "Sign up successful! Check email for confirmation."
                        : "Login successful!";
                    showMessage(message);

                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    toggleLoading(false);
                }
            }

            async function handleLogout() {
                toggleLoading(true);
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    showMessage("Logged out successfully.");
                } catch (error) {
                    showMessage("Logout error: " + error.message, 'error');
                } finally {
                    toggleLoading(false);
                }
            }

            async function handleUpload(e) {
                e.preventDefault();
                if (!telegramLinked) {
                    showMessage("Error: Please link your Telegram account before uploading.", 'error');
                    return;
                }

                const files = fileInput.files;
                if (files.length === 0) {
                    showMessage("Please select files to upload.", 'error');
                    return;
                }

                const session = supabase.auth.session();
                const token = session.access_token;
                toggleLoading(true);

                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    showMessage(`Uploading: ${file.name}...`, 'info');

                    try {
                        const response = await fetch(`${BACKEND_URL}/api/upload`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });

                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || `Upload failed for ${file.name}`);
                        showMessage(`Upload successful: ${file.name}`);
                    } catch (error) {
                        console.error('Upload Error:', error);
                        showMessage(`Upload failed for ${file.name}: ${error.message}`, 'error');
                    }
                }
                fetchGallery();
                toggleLoading(false);
                fileInput.value = '';
            }

            async function fetchGallery() {
                galleryList.innerHTML = '';
                toggleLoading(true);

                try {
                    const { data, error } = await supabase
                        .from('files')
                        .select('*')
                        .order('uploaded_at', { ascending: false });

                    if (error) throw error;

                    if (data.length === 0) {
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        data.forEach(renderFileCard);
                    }
                } catch (error) {
                    showMessage("Failed to load gallery: " + error.message, 'error');
                    emptyState.classList.remove('hidden');
                } finally {
                    toggleLoading(false);
                }
            }


            // --- Event Handlers and Initialization ---

            // Toggle Sign Up / Log In view
            toggleAuthBtn.addEventListener('click', () => {
                isSignUp = !isSignUp;
                authButton.textContent = isSignUp ? 'Sign Up' : 'Log In';
                toggleAuthBtn.textContent = isSignUp ? 'Already have an account? Log In' : 'Need an account? Sign Up';
                document.querySelector('#auth-view h2').textContent = isSignUp ? 'Create Account' : 'Welcome Back!';
            });

            // Handle Auth Submission
            authForm.addEventListener('submit', handleAuth);
            
            // Handle Upload Submission
            uploadForm.addEventListener('submit', handleUpload);

            // Listen for Supabase auth state changes (login, logout)
            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    console.log('Session access token:', session.access_token);
                }
                updateView(session);
            });
            
            // Initial setup for icons
            lucide.createIcons();
        })(); // End of IIFE
    </script>
</body>
</html>
