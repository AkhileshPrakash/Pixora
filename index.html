<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixora</title>

    <!-- ✅ Tailwind (production-safe build, no warnings) -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- Auth Section -->
    <div id="auth-section" class="flex flex-1 items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-2xl font-bold mb-4 text-center">Pixora</h1>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-gray-700 text-white" required>
                <input type="password" id="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-gray-700 text-white" required>
                <button id="auth-button" type="submit" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded">Log In</button>
            </form>
            <p class="mt-4 text-center">
                <button id="toggle-auth" class="text-blue-400 hover:underline">Don't have an account? Sign Up</button>
            </p>
        </div>
    </div>

    <!-- App Section -->
    <div id="app-section" class="hidden flex flex-col flex-1">
        <!-- Navbar -->
        <nav class="bg-gray-800 p-4 flex justify-between items-center">
            <h2 class="text-xl font-bold">Pixora</h2>
            <button id="logout-button" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded">Log Out</button>
        </nav>

        <!-- Telegram Linking Card -->
        <div id="telegram-status" class="p-6">
            <div id="telegram-status-card" class="p-4 border rounded-lg text-center bg-red-700/30 border-red-500">
                <div class="flex items-center justify-center space-x-2 mb-2">
                    <span id="link-icon" data-lucide="x-octagon"></span>
                    <span id="link-message">❌ Not linked. Please use the button below to link your account.</span>
                </div>
                <div id="status-widget"></div>
            </div>
        </div>

        <!-- Upload Panel -->
        <div id="upload-panel" class="hidden flex-1 p-6">
            <form id="upload-form" class="flex space-x-2 mb-4">
                <input type="file" id="file-input" multiple class="flex-1 px-3 py-2 rounded bg-gray-700 text-white">
                <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">Upload</button>
            </form>
            <div id="loading" class="hidden text-center">Loading...</div>
            <div id="empty-state" class="hidden text-center text-gray-400">No files uploaded yet.</div>
            <div id="gallery-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script type="module">
        // --- Config ---
        const SUPABASE_URL = "https://YOUR_SUPABASE_PROJECT.supabase.co";
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
        const BACKEND_URL = "https://your-backend.com";
        const RENDER_URL = "https://your-render.com";

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('auth-button');
        const toggleAuthBtn = document.getElementById('toggle-auth');
        const logoutButton = document.getElementById('logout-button');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const galleryList = document.getElementById('gallery-list');
        const loadingIndicator = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const telegramStatusCard = document.getElementById('telegram-status-card');
        const linkIcon = document.getElementById('link-icon');
        const linkMessage = document.getElementById('link-message');
        const statusWidgetContainer = document.getElementById('status-widget');
        const uploadPanel = document.getElementById('upload-panel');

        let isSignUp = false;

        // --- Functions ---
        function updateView(session) {
            if (session) {
                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                checkTelegramLink();
                fetchGallery();
            } else {
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;

            let result;
            if (isSignUp) {
                result = await supabase.auth.signUp({ email, password });
            } else {
                result = await supabase.auth.signIn({ email, password });
            }

            if (result.error) {
                alert(result.error.message);
            }
        }

        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
            updateView(null);
        });

        async function checkTelegramLink() {
            try {
                const session = supabase.auth.session();
                if (!session) return;

                const response = await fetch(`${BACKEND_URL}/api/telegram/status`, {
                    headers: { 'Authorization': `Bearer ${session.access_token}` }
                });
                const result = await response.json();

                if (response.ok && result.linked) {
                    updateLinkStatusUI(true);
                } else {
                    updateLinkStatusUI(false);
                }
            } catch (error) {
                console.error("Telegram link check error:", error);
                updateLinkStatusUI(false);
            }
        }

        function updateLinkStatusUI(linked) {
            statusWidgetContainer.innerHTML = '';
            if (linked) {
                telegramStatusCard.classList.remove('bg-red-700/30', 'border-red-500');
                telegramStatusCard.classList.add('bg-green-700/30', 'border-green-500');
                linkIcon.innerHTML = '';
                linkIcon.setAttribute("data-lucide", "check-circle");
                lucide.createIcons();
                linkMessage.textContent = "✅ Account linked with Telegram.";
                uploadPanel.classList.remove('hidden');
            } else {
                telegramStatusCard.classList.remove('bg-green-700/30', 'border-green-500');
                telegramStatusCard.classList.add('bg-red-700/30', 'border-red-500');
                linkIcon.innerHTML = '';
                linkIcon.setAttribute("data-lucide", "x-octagon");
                lucide.createIcons();
                linkMessage.textContent = "❌ Not linked. Please use the button below to link your account.";

                // ✅ Safe way to add Telegram widget (instead of innerHTML <script>)
                const widget = document.createElement("script");
                widget.src = "https://telegram.org/js/telegram-widget.js?22";
                widget.async = true;
                widget.setAttribute("data-telegram-login", "PixoraLoginBot");
                widget.setAttribute("data-size", "large");
                widget.setAttribute("data-auth-url", `${RENDER_URL}/api/auth/telegram`);
                widget.setAttribute("data-request-access", "write");
                statusWidgetContainer.appendChild(widget);

                uploadPanel.classList.add('hidden');
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const files = fileInput.files;
            if (!files.length) return;

            toggleLoading(true);
            for (const file of files) {
                try {
                    const session = supabase.auth.session();
                    if (!session) return;

                    const formData = new FormData();
                    formData.append("file", file);

                    const response = await fetch(`${BACKEND_URL}/api/upload`, {
                        method: "POST",
                        headers: { 'Authorization': `Bearer ${session.access_token}` },
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || "Upload failed.");
                } catch (error) {
                    console.error("Upload error:", error);
                    alert(`Upload failed: ${file.name}`);
                }
            }
            toggleLoading(false);
            fetchGallery();
        }

        async function fetchGallery() {
            toggleLoading(true);
            try {
                const session = supabase.auth.session();
                if (!session) return;

                const response = await fetch(`${BACKEND_URL}/api/files`, {
                    headers: { 'Authorization': `Bearer ${session.access_token}` }
                });
                const result = await response.json();

                if (!response.ok) throw new Error(result.error || "Failed to fetch files.");

                galleryList.innerHTML = '';
                if (result.files && result.files.length > 0) {
                    result.files.forEach(file => {
                        const card = document.createElement("div");
                        card.className = "bg-gray-800 p-2 rounded shadow";
                        card.innerHTML = `<img src="${file.url}" alt="${file.name}" class="rounded">`;
                        galleryList.appendChild(card);
                    });
                    emptyState.classList.add('hidden');
                } else {
                    emptyState.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Fetch gallery error:", error);
                alert("Error loading gallery: " + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        function toggleLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        // --- Event Listeners ---
        authForm.addEventListener('submit', handleAuth);
        toggleAuthBtn.addEventListener('click', () => {
            isSignUp = !isSignUp;
            authButton.textContent = isSignUp ? "Sign Up" : "Log In";
            toggleAuthBtn.textContent = isSignUp 
                ? "Already have an account? Log In" 
                : "Don't have an account? Sign Up";
        });
        uploadForm.addEventListener('submit', handleUpload);

        // --- Supabase Auth State Listener ---
        supabase.auth.onAuthStateChange((_event, session) => {
            updateView(session);
        });

        // Initial setup for icons
        lucide.createIcons();
    </script>
</body>
</html>
